<!-- run_results.html -->
{% extends "base.html" %}
{% block title %}Run Results - {{ problem.title }}{% endblock %}

{% block extra_head %}
  <!-- highlight.js CSS (theme) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <style>
    .code-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: .5rem 0 .25rem;
      gap: .5rem;
    }
    .copy-btn {
      padding: .35rem .6rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: .85rem;
      cursor: pointer;
      background: #fff;
    }
    .copy-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .copy-btn.copied {
      background: #d1e7dd;
      border-color: #a3cfbb;
      color: #0f5132;
    }
    .verdict.accepted { color: #1a7f37; }
    .verdict.rejected { color: #d1242f; }
    .test-results-table tr.passed {
      background-color: #d1e7dd;
    }
    .test-results-table tr.failed {
      background-color: #f8d7da;
    }
    .action-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .btn {
      padding: .5rem 1rem;
      text-decoration: none;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fff;
      color: #333;
      transition: all 0.2s;
    }
    .btn:hover {
      background: #f0f0f0;
      text-decoration: none;
    }
    .btn-primary {
      background: #007bff;
      border-color: #007bff;
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
      border-color: #0056b3;
      color: white;
    }
    .btn-secondary {
      background: #6c757d;
      border-color: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background: #545b62;
      border-color: #545b62;
      color: white;
    }
  </style>
{% endblock %}

{% block content %}
<div class="card">
  <h2>üîç Code Run Results</h2>

  <div class="mb-2">
    <p><strong>Problem:</strong> <a href="{% url 'problem_detail' problem.id %}">{{ problem.title }}</a></p>
    <p><strong>Language:</strong> {{ language }}</p>
    <p><strong>Verdict:</strong>
      <span class="verdict {% if verdict == 'Accepted' %}accepted{% else %}rejected{% endif %}">
        {% if verdict == 'Accepted' %}‚úÖ{% else %}‚ùå{% endif %} {{ verdict }}
      </span>
    </p>
    {% if execution_time %}
      <p><strong>Execution Time:</strong> {{ execution_time }}ms</p>
    {% endif %}
    {% if memory_usage %}
      <p><strong>Memory Usage:</strong> {{ memory_usage }}KB</p>
    {% endif %}
  </div>

  <h3>üíª Your Code:</h3>

  <!-- optional small toolbar above the code -->
  <div class="code-toolbar">
    <span></span>
    <button id="copy-code" class="copy-btn" type="button">üìã Copy</button>
  </div>

  <!-- Read-only code with highlight.js; escape to prevent XSS, preserve newlines -->
  <div class="code-block">
    <pre><code id="user-code"
      class="language-{{ language|lower|default:'plaintext' }}">{{ code|default_if_none:""|escape }}</code></pre>
  </div>

  <h3>üß™ Sample Test Case Results:</h3>
  {% if results %}
    <div class="styled-table">
      <table class="test-results-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Input</th>
            <th>Expected Output</th>
            <th>Your Output</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for r in results %}
            <tr class="{% if r.passed %}passed{% else %}failed{% endif %}">
              <td>{{ forloop.counter }}</td>
              <td><pre>{{ r.test_case.input_data }}</pre></td>
              <td><pre>{{ r.test_case.output_data }}</pre></td>
              <td><pre>{{ r.user_output }}</pre></td>
              <td>{% if r.passed %}‚úÖ Passed{% else %}‚ùå Failed{% endif %}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>üîç No sample tests found for this problem.</p>
  {% endif %}

  {% if error_message %}
    <h3>‚ö†Ô∏è Error Details:</h3>
    <div class="alert alert-danger">
      <pre>{{ error_message }}</pre>
    </div>
  {% endif %}

  <div class="mt-3">
    <div class="action-buttons">
      <a href="{% url 'problem_detail' problem.id %}" class="btn btn-primary">
        üîô Back to Problem
      </a>
      {% if verdict == 'Accepted' %}
        <a href="{% url 'problem_list' %}" class="btn btn-secondary">
          üìù Try Another Problem
        </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- highlight.js JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
  // Initialize syntax highlighting
  hljs.highlightAll();

  // Copy code functionality
  document.getElementById('copy-code').addEventListener('click', function() {
    const codeElement = document.getElementById('user-code');
    const text = codeElement.textContent;
    
    navigator.clipboard.writeText(text).then(function() {
      const btn = document.getElementById('copy-code');
      const originalText = btn.innerHTML;
      
      btn.innerHTML = '‚úÖ Copied!';
      btn.classList.add('copied');
      
      setTimeout(function() {
        btn.innerHTML = originalText;
        btn.classList.remove('copied');
      }, 2000);
    }).catch(function(err) {
      console.error('Could not copy text: ', err);
      alert('Failed to copy code to clipboard');
    });
  });
</script>
{% endblock %}