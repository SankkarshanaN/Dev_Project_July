<!-- submit.html -->
{% extends "base.html" %}
{% block title %}Submit Code - CodeFun{% endblock %}

{% block extra_head %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/material.min.css">
<style>
    .CodeMirror {
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        height: auto;
        min-height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸš€ Submit Your Solution</h2>
    <p><strong>Problem:</strong> {{ problem.title }}</p>
    
    <form method="POST" action="{% url 'submissions:submit_code' problem.id %}">
        {% csrf_token %}
        
        <!-- Language Selection -->
        <div class="form-group">
            <label for="language">ğŸ”§ Programming Language:</label>
            <select name="language" id="language" class="language-select" required>
                <option value="python" {% if request.POST.language == "python" %}selected{% endif %}>ğŸ Python</option>
                <option value="cpp" {% if request.POST.language == "cpp" %}selected{% endif %}>âš¡ C++</option>
                <option value="c" {% if request.POST.language == "c" %}selected{% endif %}>ğŸ”© C</option>
                <option value="java" {% if request.POST.language == "java" %}selected{% endif %}>â˜• Java</option>
            </select>
        </div>
        
        <!-- Code Editor -->
        <div class="form-group">
            <label for="code">ğŸ’» Your Code:</label>
            <!-- hidden textarea that will actually submit -->
            <textarea name="code" id="code" style="display:none;">{{ request.POST.code|default_if_none:"" }}</textarea>
            <!-- CodeMirror editor will attach here -->
            <div id="editor">{{ request.POST.code|default_if_none:"" }}</div>
        </div>
        
        <!-- Submit Button -->
        <button type="submit" class="btn-submit">ğŸš€ Submit Solution</button>
    </form>

    <!-- Optional Preview -->
    {% if request.POST.code %}
    <h3 class="mt-4">ğŸ“‹ Code Preview:</h3>
    <div class="code-block">
        <pre><code>{{ request.POST.code }}</code></pre>
    </div>
    {% endif %}

    <div class="mt-3">
        <a class="btn" href="{% url 'problem_detail' problem.id %}">â¬… Back to Problem</a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/clike/clike.min.js"></script>

<script>
    // Setup CodeMirror editor
    const editor = CodeMirror(document.getElementById("editor"), {
        value: document.getElementById("code").value,
        mode: "python", // default
        theme: "material",
        lineNumbers: true,
        tabSize: 4,
        indentUnit: 4,
        matchBrackets: true,
        autoCloseBrackets: true,
    });

    // Update editor mode based on selected language
    document.getElementById("language").addEventListener("change", (e) => {
        const lang = e.target.value;
        if (lang === "python") editor.setOption("mode", "python");
        if (lang === "cpp" || lang === "c") editor.setOption("mode", "text/x-c++src");
        if (lang === "java") editor.setOption("mode", "text/x-java");
    });

    // Sync CodeMirror content back into hidden textarea before submit
    document.querySelector("form").addEventListener("submit", () => {
        document.getElementById("code").value = editor.getValue();
    });
</script>
{% endblock %}
