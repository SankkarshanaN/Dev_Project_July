{% extends "base.html" %}
{% load static %}

{% block title %}{{ problem.title }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/theme/dracula.min.css">
<link rel="stylesheet" href="{% static 'css/custom-io.css' %}">

<div class="card problem-page" style="display: flex; gap: 2rem; flex-wrap: wrap;">

    <!-- Problem Statement Section -->
    <div class="problem-statement" style="flex: 1; min-width: 300px;">
        <h2>{{ problem.title }}</h2>
        <p class="difficulty {{ problem.difficulty|lower }}">
            Difficulty: {{ problem.difficulty }}
        </p>

        {% if problem.description %}
        <div>
            <h3>Description</h3>
            <p>{{ problem.description|linebreaks }}</p>
        </div>
        {% endif %}

        {% if problem.input_format %}
        <div>
            <h3>Input Format</h3>
            <pre>{{ problem.input_format }}</pre>
        </div>
        {% endif %}

        {% if problem.output_format %}
        <div>
            <h3>Output Format</h3>
            <pre>{{ problem.output_format }}</pre>
        </div>
        {% endif %}

        {% if problem.constraints %}
        <div>
            <h3>Constraints</h3>
            <pre>{{ problem.constraints }}</pre>
        </div>
        {% endif %}

        <!-- ðŸ”¹ Show only sample test cases -->
        {% if sample_test_cases %}
        <div>
            <h3>Sample Test Cases</h3>
            {% for case in sample_test_cases %}
                <div class="testcase" style="margin-bottom: 1rem;">
                    <strong>Input:</strong>
                    <pre>{{ case.input_data }}</pre>
                    <strong>Output:</strong>
                    <pre>{{ case.output_data }}</pre>
                </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Code Editor Section -->
    <div class="code-editor-container" style="flex: 1; min-width: 300px;">
        <form method="POST" action="{% url 'submissions:submit_code' problem.id %}" class="code-editor-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="language">Language:</label>
                <select name="language" id="language" class="language-select">
                    <option value="python">Python</option>
                    <option value="cpp">C++</option>
                    <option value="c">C</option>
                    <option value="java">Java</option>
                </select>
            </div>

            <!-- CodeMirror will attach here -->
            <textarea id="code" name="code"></textarea>

            <div class="form-actions" style="margin-top: 1rem;">
                <button type="submit" name="action" value="run" class="btn-run">Run Code</button>
                <button type="submit" name="action" value="submit" class="btn-submit">Submit Code</button>
            </div>
        </form>

        <!-- ðŸ”¹ Custom Input/Output Section -->
        <div class="custom-io-container">
            <h3>Custom Input / Output</h3>

            <!-- Input -->
            <textarea id="custom-input" placeholder="Enter your input here..."></textarea>

            <!-- Run Button -->
            <button id="run-custom-btn">Run with Custom Input</button>

            <!-- Output -->
            <div class="output-container">
                <h4>Output:</h4>
                <pre id="custom-output"></pre>
            </div>
        </div>
    </div>
</div>

<!-- CodeMirror Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/edit/closebrackets.min.js"></script>

<script>
    // Setup CodeMirror
    const editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        mode: "python",
        theme: "dracula",
        matchBrackets: true,
        autoCloseBrackets: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: true,
    });

    // Pass values into Django form on submit
    document.querySelector(".code-editor-form").addEventListener("submit", function () {
        document.getElementById("code").value = editor.getValue();
    });

    // Custom Run button
    const runBtn = document.getElementById("run-custom-btn");
    runBtn.addEventListener("click", async function () {
        const code = editor.getValue();
        const language = document.getElementById("language").value;
        const customInput = document.getElementById("custom-input").value;

        const response = await fetch("{% url 'submissions:run_custom' problem.id %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({
                code: code,
                language: language,
                custom_input: customInput
            })
        });

        const result = await response.json();
        document.getElementById("custom-output").textContent = result.output || result.error || "No output.";
    });
</script>
{% endblock %}
